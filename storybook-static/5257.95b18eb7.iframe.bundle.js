(self.webpackChunkweb=self.webpackChunkweb||[]).push([[5257],{"./src/screens/login/index/index.tsx":(e,t,n)=>{var r=n("./node_modules/@babel/runtime/regenerator/index.js");n("./node_modules/core-js/modules/es.object.define-property.js"),n("./node_modules/core-js/modules/es.reflect.construct.js"),n("./node_modules/core-js/modules/es.array.concat.js"),n("./node_modules/core-js/modules/es.array.index-of.js"),n("./node_modules/core-js/modules/web.timers.js"),n("./node_modules/core-js/modules/es.string.replace.js"),n("./node_modules/core-js/modules/es.regexp.exec.js");var s=n("./node_modules/@babel/runtime/helpers/interopRequireDefault.js");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=s(n("./node_modules/@babel/runtime/helpers/asyncToGenerator.js")),i=s(n("./node_modules/@babel/runtime/helpers/classCallCheck.js")),a=s(n("./node_modules/@babel/runtime/helpers/createClass.js")),d=s(n("./node_modules/@babel/runtime/helpers/assertThisInitialized.js")),l=s(n("./node_modules/@babel/runtime/helpers/inherits.js")),u=s(n("./node_modules/@babel/runtime/helpers/possibleConstructorReturn.js")),c=s(n("./node_modules/@babel/runtime/helpers/getPrototypeOf.js")),f=s(n("./node_modules/@babel/runtime/helpers/defineProperty.js")),m=s(n("./node_modules/react/index.js")),p=s(n("./node_modules/react-native-web/dist/exports/View/index.js")),h=n("./src/components/index.ts"),_=n("./src/screens/_/index.ts"),x=n("./src/stores/index.ts"),g=n("./src/utils/index.ts"),y=n("./src/utils/decorators/index.ts"),b=n("./src/utils/fetch/index.ts"),j=n("./src/utils/html/index.ts"),v=n("./src/utils/ui/index.ts"),k=n("./src/constants/index.ts"),w=s(n("./src/constants/i18n/index.ts")),S=n("./src/screens/login/index/styles.ts"),T=n("./node_modules/react/jsx-runtime.js");function O(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,c.default)(e);if(t){var s=(0,c.default)(this).constructor;n=Reflect.construct(r,arguments,s)}else n=r.apply(this,arguments);return(0,u.default)(this,n)}}var R=k.URL_OAUTH+"?"+(0,g.urlStringify)({response_type:"code",client_id:k.APP_ID,redirect_uri:k.URL_OAUTH_REDIRECT}),C=function(e){(0,l.default)(n,e);var t=O(n);function n(){var e,s;(0,i.default)(this,n);for(var a=arguments.length,l=new Array(a),u=0;u<a;u++)l[u]=arguments[u];return e=t.call.apply(t,[this].concat(l)),(0,f.default)((0,d.default)(e),"state",{clicked:!1,refreshed:!1}),(0,f.default)((0,d.default)(e),"ref",void 0),(0,f.default)((0,d.default)(e),"onTour",(function(){e.props.navigation.goBack()})),(0,f.default)((0,d.default)(e),"onLogin",(function(){(0,b.t)("授权登陆.登陆"),e.setState({clicked:!0})})),(0,f.default)((0,d.default)(e),"onMessage",(s=(0,o.default)(r.mark((function t(n){var s,o,i;return r.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:t.prev=0,s=JSON.parse(n.nativeEvent.data),o=s.type,i=s.data,t.t0=o,t.next="onload"===t.t0?5:7;break;case 5:return i&&(-1!==i.href.indexOf(k.HOST+"/login?")||(-1!==i.href.indexOf(k.URL_OAUTH+"?")?-1===i.href.indexOf("redirect_uri")&&(e.updateUserCookie(i),e.refreshWebView()):-1!==i.href.indexOf(k.URL_OAUTH_REDIRECT+"?code=")?e.doLogin(i):setTimeout((function(){e.onOtherPage()}),1600))),t.abrupt("break",8);case 7:return t.abrupt("break",8);case 8:t.next=12;break;case 10:t.prev=10,t.t1=t.catch(0);case 12:case"end":return t.stop()}}),t,null,[[0,10]])}))),function(e){return s.apply(this,arguments)})),(0,f.default)((0,d.default)(e),"onError",(function(){(0,b.t)("授权登陆.错误"),(0,v.info)("网络似乎出了点问题"),e.setState({clicked:!1})})),(0,f.default)((0,d.default)(e),"onOtherPage",(function(){(0,b.t)("授权登陆.乱逛"),(0,v.info)("授权过程中不要随便乱逛>.<"),e.setState({clicked:!1})})),(0,f.default)((0,d.default)(e),"refreshWebView",(function(){e.setState({refreshed:!0}),setTimeout((function(){e.setState({refreshed:!1})}),800)})),(0,f.default)((0,d.default)(e),"updateUserCookie",(function(e){var t=e.userAgent,n=e.cookie;return x.userStore.updateUserCookie({userAgent:t,cookie:n,v:0})})),(0,f.default)((0,d.default)(e),"doLogin",(0,o.default)(r.mark((function t(){var n,s,o,i,a=arguments;return r.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=(a.length>0&&void 0!==a[0]?a[0]:{}).href,s=void 0===n?"":n,o=e.props.navigation,i=s.replace(k.URL_OAUTH_REDIRECT+"?code=",""),t.prev=3,(0,v.info)("获取token中, 请稍等...",6),t.next=7,x.userStore.fetchAccessToken(i);case 7:t.next=13;break;case 9:return t.prev=9,t.t0=t.catch(3),e.setState({clicked:!1}),t.abrupt("return");case 13:return t.next=15,x.userStore.fetchUserInfo();case 15:return t.next=17,x.userStore.fetchUsersInfo();case 17:(0,v.feedback)(),o.popToTop(),(0,b.t)("授权登陆.成功");case 20:case"end":return t.stop()}}),t,null,[[3,9]])})))),e}return(0,a.default)(n,[{key:"componentDidMount",value:function(){(0,b.hm)("login","Login")}},{key:"renderPreview",value:function(){return(0,T.jsxs)(p.default,{style:[x._.container.column,x._.container.plain],children:[(0,T.jsx)(h.Mesume,{}),(0,T.jsxs)(p.default,{style:[this.styles.bottomContainer,x._.mt.lg],children:[(0,T.jsxs)(h.Button,{type:"main",shadow:!0,onPress:this.onLogin,children:["授权",w.default.login()]}),(0,T.jsx)(h.Button,{style:x._.mt.md,type:"plain",shadow:!0,onPress:this.onTour,children:"返回"}),(0,T.jsxs)(h.Text,{style:x._.mt.lg,size:12,lineHeight:14,type:"sub",children:["PS: 若",w.default.login(),"出现问题, 请先在授权网页里面登出, 不然会出现成功后",w.default.login(),"过期的情况."]})]})]})}},{key:"renderLoading",value:function(){return(0,T.jsxs)(p.default,{style:[x._.container.column,x._.container.plain],children:[(0,T.jsx)(h.Mesume,{}),(0,T.jsx)(p.default,{style:[this.styles.bottomContainer,x._.mt.md],children:(0,T.jsxs)(h.Flex,{style:this.styles.loading,direction:"column",justify:"center",children:[(0,T.jsx)(h.Loading.Raw,{color:x._.colorMain}),(0,T.jsx)(h.Text,{style:x._.mt.md,size:12,type:"main",children:"网页加载中, 请稍等"})]})})]})}},{key:"renderWebView",value:function(){var e=this;if(this.state.refreshed)return null;var t="(function(){\n      /* 注入优化样式 */\n      document.querySelector('html').dataset.theme = \""+x._.select("light","dark")+'";\n\n      /* 隐藏会乱跳转的元素 */\n      var resetStyle = document.createElement("style");\n      try {\n        resetStyle.appendChild(document.createTextNode("'+(0,j.HTMLTrim)("\n            #badgeUserPanel {\n              display: block !important;\n              top: 8px !important;\n              left: -120px !important;\n            }\n            .logo,\n            .idBadgerNeue,\n            #columnLoginB,\n            .family,\n            .menuCompact,\n            .headerNeueInner .avatar,\n            #badgeUserPanel li:not(:last-child),\n            #badgeUserPanel li:last-child a:not(:last-child) {\n              display: none !important;\n            }\n          ")+'"));\n      } catch (ex) {}\n      document.body.append(resetStyle);\n\n      setTimeout(() => {\n        /* webview的postMessage不是马上生效的 */\n        var __timeoutId = null;\n        var __isBridgeOk = false;\n\n        function waitForBridge() {\n          if (!__isBridgeOk && !window'+(k.SDK>=36?".ReactNativeWebView":"")+".postMessage) {\n            __timeoutId = setTimeout(waitForBridge, 400);\n          } else {\n            clearTimeout(__timeoutId);\n            __timeoutId = null;\n            __isBridgeOk = true;\n\n            setTimeout(() => {\n              window"+(k.SDK>=36?".ReactNativeWebView":"")+".postMessage(JSON.stringify({\n                type: 'onload',\n                data: {\n                  href: document.location.href,\n                  userAgent: navigator.userAgent,\n                  cookie: document.cookie\n                }\n              }));\n            }, 0)\n          }\n        }\n\n        waitForBridge();\n      }, 1000)\n    }());";return(0,T.jsx)(h.WebView,{ref:function(t){return e.ref=t},style:x._.container.plain,uri:R,javaScriptEnabled:!0,injectedJavaScript:t,startInLoadingState:!0,mixedContentMode:"always",renderLoading:function(){return e.renderLoading()},onError:this.onError,onMessage:this.onMessage})}},{key:"render",value:function(){var e=this.state.clicked;return(0,T.jsxs)(h.Component,{id:"screen-login",style:x._.container.plain,children:[(0,T.jsx)(_.StatusBarPlaceholder,{}),(0,T.jsx)(p.default,{style:x._.container.flex,children:e?this.renderWebView():this.renderPreview()}),(0,T.jsx)(h.Heatmap,{right:x._.wind,bottom:x._.bottom+120,id:"授权登陆.登陆",transparent:!0}),(0,T.jsx)(h.Heatmap,{right:x._.wind+31,bottom:x._.bottom+86,id:"授权登陆.成功",transparent:!0}),(0,T.jsx)(h.Heatmap,{right:x._.wind,bottom:x._.bottom+86,id:"授权登陆.错误",transparent:!0}),(0,T.jsx)(h.Heatmap,{right:x._.wind,bottom:x._.bottom+52,id:"授权登陆.乱逛",transparent:!0}),(0,T.jsx)(h.Heatmap,{id:"授权登陆",screen:"LoginV1"})]})}},{key:"styles",get:function(){return(0,S.memoStyles)()}}]),n}(m.default.Component);t.default=(0,y.ob)(C);try{index.displayName="index",index.__docgenInfo={description:"",displayName:"index",props:{navigation:{defaultValue:null,description:"",name:"navigation",required:!0,type:{name:"Navigation"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/screens/login/index/index.tsx#index"]={docgenInfo:index.__docgenInfo,name:"index",path:"src/screens/login/index/index.tsx#index"})}catch(e){}},"./src/screens/login/index/styles.ts":(e,t,n)=>{n("./node_modules/core-js/modules/es.object.define-property.js"),Object.defineProperty(t,"__esModule",{value:!0}),t.memoStyles=void 0;var r=n("./src/stores/index.ts");t.memoStyles=r._.memoStyles((function(){return{bottomContainer:{width:r._.r(320),height:400},loading:{width:r._.r(320),height:64}}}))}}]);