(self.webpackChunkweb=self.webpackChunkweb||[]).push([[2356],{"./src/screens/login/v2/ds.ts":(e,t,s)=>{s("./node_modules/core-js/modules/es.object.define-property.js"),Object.defineProperty(t,"__esModule",{value:!0}),t.UA_EKIBUN_BANGUMI_APP=t.TITLE=t.NAMESPACE=t.AUTH_RETRY_COUNT=void 0;t.TITLE="登录",t.NAMESPACE="LoginV2",t.AUTH_RETRY_COUNT=4,t.UA_EKIBUN_BANGUMI_APP="Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Mobile Safari/537.36"},"./src/screens/login/v2/form/index.tsx":(e,t,s)=>{s("./node_modules/core-js/modules/es.object.define-property.js"),s("./node_modules/core-js/modules/es.reflect.construct.js"),s("./node_modules/core-js/modules/es.array.concat.js"),s("./node_modules/core-js/modules/es.array.includes.js"),s("./node_modules/core-js/modules/es.string.includes.js");var n=s("./node_modules/@babel/runtime/helpers/interopRequireDefault.js");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=n(s("./node_modules/@babel/runtime/helpers/classCallCheck.js")),r=n(s("./node_modules/@babel/runtime/helpers/createClass.js")),a=n(s("./node_modules/@babel/runtime/helpers/assertThisInitialized.js")),i=n(s("./node_modules/@babel/runtime/helpers/inherits.js")),u=n(s("./node_modules/@babel/runtime/helpers/possibleConstructorReturn.js")),l=n(s("./node_modules/@babel/runtime/helpers/getPrototypeOf.js")),d=n(s("./node_modules/@babel/runtime/helpers/defineProperty.js")),c=n(s("react")),f=n(s("./node_modules/react-native-web/dist/exports/Image/index.js")),m=n(s("./node_modules/react-native-web/dist/exports/View/index.js")),h=n(s("./node_modules/@ant-design/react-native/lib/activity-indicator/index.js")),p=s("./src/components/index.ts"),y=s("./src/screens/_/index.ts"),j=s("./src/stores/index.ts"),g=s("./src/utils/index.ts"),x=s("./src/utils/decorators/index.ts"),_=s("./src/utils/fetch/index.ts"),b=s("./src/constants/index.ts"),v=n(s("./src/constants/i18n/index.ts")),C=s("./src/screens/login/v2/form/styles.ts"),w=s("./node_modules/react/jsx-runtime.js");function S(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var s,n=(0,l.default)(e);if(t){var o=(0,l.default)(this).constructor;s=Reflect.construct(n,arguments,o)}else s=n.apply(this,arguments);return(0,u.default)(this,s)}}var A=[b.HOST,b.HOST_2,b.HOST_3],k=function(e){(0,i.default)(s,e);var t=S(s);function s(){var e;(0,o.default)(this,s);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=t.call.apply(t,[this].concat(r)),(0,d.default)((0,a.default)(e),"state",{config:!1}),(0,d.default)((0,a.default)(e),"passwordRef",void 0),(0,d.default)((0,a.default)(e),"codeRef",void 0),(0,d.default)((0,a.default)(e),"showConfig",(function(){return e.setState({config:!0})})),(0,d.default)((0,a.default)(e),"onNoticeHost",(function(){(0,_.t)("登陆.配置提示",{name:"host"}),(0,g.alert)("三个选项都是同一个站点的不同域名，只是具体服务器位置不同。 \n\n"+v.default.login()+"建议优先使用 bgm.tv，出现问题再尝试 bangumi.tv，最后尝试 chii.in。")})),(0,d.default)((0,a.default)(e),"onNoticeUA",(function(){(0,_.t)("登陆.配置提示",{name:"ua"}),(0,g.alert)("假如您频繁掉授权状态，不妨试试把这个选项勾上，通常"+v.default.login()+"状态生存时间为7天。 \n\n这是个不稳定的选项，若"+v.default.login()+"正常不建议勾上，可能会遇到预测不能的状况。")})),(0,d.default)((0,a.default)(e),"onSubmitEditingEmail",(function(){try{var t,s,n;"function"==typeof(null==(t=(0,a.default)(e))||null==(s=t.passwordRef)||null==(n=s.inputRef)?void 0:n.focus)&&e.passwordRef.inputRef.focus()}catch(e){}})),(0,d.default)((0,a.default)(e),"onSubmitEditingPassword",(function(){try{var t,s,n;"function"==typeof(null==(t=(0,a.default)(e))||null==(s=t.codeRef)||null==(n=s.inputRef)?void 0:n.focus)&&e.codeRef.inputRef.focus()}catch(e){}})),e}return(0,r.default)(s,[{key:"componentDidMount",value:function(){var e=this.props,t=e.email,s=e.password,n=e.captcha;if(t&&s&&!n)try{var o,r;"function"==typeof(null==this||null==(o=this.codeRef)||null==(r=o.inputRef)?void 0:r.focus)&&this.codeRef.inputRef.focus()}catch(e){}}},{key:"renderForm",value:function(){var e=this,t=this.props,s=t.email,n=t.password,o=t.captcha,r=t.base64,a=t.forwardRef,i=t.onGetCaptcha,u=t.onFocus,l=t.onBlur,d=t.onChange,c=t.onLogin;return(0,w.jsxs)(w.Fragment,{children:[(0,w.jsx)(p.Flex,{style:j._.mt.lg,children:(0,w.jsx)(p.Flex.Item,{children:(0,w.jsx)(p.Input,{style:this.styles.input,value:s,placeholder:"Email",returnKeyType:"next",onFocus:u,onBlur:l,onChange:function(e){return d(e,"email")},onSubmitEditing:this.onSubmitEditingEmail})})}),(0,w.jsx)(p.Flex,{style:j._.mt.md,children:(0,w.jsx)(p.Flex.Item,{children:(0,w.jsx)(p.Input,{ref:function(t){return e.passwordRef=t},style:this.styles.input,value:n,placeholder:"密码",secureTextEntry:!0,returnKeyType:"next",onFocus:u,onBlur:l,onChange:function(e){return d(e,"password")},onSubmitEditing:this.onSubmitEditingPassword})})}),(0,w.jsxs)(p.Flex,{style:j._.mt.md,children:[(0,w.jsx)(p.Flex.Item,{children:(0,w.jsx)(p.Input,{ref:function(t){a(t),e.codeRef=t},style:this.styles.input,value:o,placeholder:"验证码",returnKeyType:"done",returnKeyLabel:v.default.login(),onFocus:u,onBlur:l,onChange:function(e){return d(e,"captcha")},onSubmitEditing:c})}),(0,w.jsx)(p.Touchable,{style:this.styles.touchCaptcha,onPress:i,children:(0,w.jsx)(p.Flex,{style:this.styles.captchaContainer,justify:"center",children:r?(0,w.jsx)(f.default,{style:this.styles.captcha,source:{uri:r}}):(0,w.jsx)(h.default,{size:"small"})})})]})]})}},{key:"renderConfig",value:function(){var e=this.props,t=e.failed,s=e.isCommonUA,n=e.host,o=e.onSelect,r=e.onUAChange;return t?this.state.config?(0,w.jsxs)(w.Fragment,{children:[(0,w.jsxs)(p.Flex,{style:[this.styles.touch,j._.mt.sm],children:[(0,w.jsx)(p.Flex.Item,{children:(0,w.jsx)(y.Popover,{style:this.styles.touch,data:A,onSelect:o,children:(0,w.jsxs)(p.Flex,{style:this.styles.content,children:[(0,w.jsxs)(p.Text,{type:"sub",size:12,children:["使用 ",n," 进行",v.default.login()]}),(0,w.jsx)(p.Iconfont,{name:"md-keyboard-arrow-down"})]})})}),(0,w.jsx)(p.Touchable,{style:this.styles.touchIcon,onPress:this.onNoticeHost,children:(0,w.jsx)(p.Flex,{style:this.styles.icon,justify:"center",children:(0,w.jsx)(p.Iconfont,{name:"md-info-outline",size:18})})})]}),(0,w.jsxs)(p.Flex,{style:this.styles.touch,children:[(0,w.jsx)(p.Flex.Item,{children:(0,w.jsx)(p.Touchable,{style:this.styles.touch,onPress:r,children:(0,w.jsxs)(p.Flex,{style:this.styles.content,children:[(0,w.jsx)(p.Iconfont,{name:s?"md-radio-button-on":"md-radio-button-off",color:s?j._.colorMain:j._.colorSub,size:18}),(0,w.jsxs)(p.Text,{style:j._.ml.xs,type:"sub",size:12,children:["使用固定UA",v.default.login()," (频繁掉线请勾选)"]})]})})}),(0,w.jsx)(p.Touchable,{style:this.styles.touchIcon,onPress:this.onNoticeUA,children:(0,w.jsx)(p.Flex,{style:this.styles.icon,justify:"center",children:(0,w.jsx)(p.Iconfont,{name:"md-info-outline",size:18})})})]})]}):(0,w.jsxs)(p.Touchable,{style:[this.styles.touch,j._.mt.sm],onPress:this.showConfig,children:[(0,w.jsxs)(p.Flex,{style:this.styles.content,children:[(0,w.jsxs)(p.Text,{type:"sub",size:12,children:[v.default.login(),"配置"]}),(0,w.jsx)(p.Iconfont,{name:"md-navigate-next"})]}),(0,w.jsx)(p.Heatmap,{id:"登陆.切换域名"}),(0,w.jsx)(p.Heatmap,{bottom:-32,id:"登陆.配置提示",transparent:!0})]}):null}},{key:"renderError",value:function(){var e=this.props,t=e.navigation,s=e.info,n=s.includes("错误");return(0,w.jsxs)(w.Fragment,{children:[(0,w.jsx)(p.Text,{style:j._.mt.md,size:12,lineHeight:16,type:"sub",onPress:function(){n&&t.push("Login")},children:s}),n&&(0,w.jsxs)(p.Text,{style:j._.mt.md,size:12,lineHeight:16,type:"sub",onPress:function(){return t.push("LoginAssist")},children:["请尝试切换另一域名进行重试，或尝试切换wifi或4g网络，实在没法",v.default.login(),"，可点击这里前往辅助",v.default.login(),"→"]})]})}},{key:"render",value:function(){var e=this.props,t=e.loading,s=e.onLogin;return(0,w.jsx)(m.default,{style:j._.container.column,children:(0,w.jsxs)(m.default,{style:this.styles.form,children:[(0,w.jsx)(p.Flex,{justify:"center",children:(0,w.jsx)(p.Mesume,{})}),this.renderForm(),!b.WEB&&this.renderConfig(),(0,w.jsx)(p.Button,{style:j._.mt.lg,type:"main",shadow:!0,loading:t,onPress:s,children:v.default.login()}),this.renderError()]})})}},{key:"styles",get:function(){return(0,C.memoStyles)()}}]),s}(c.default.Component);(0,d.default)(k,"defaultProps",{host:"",forwardRef:b.FROZEN_FN,onGetCaptcha:b.FROZEN_FN,onFocus:b.FROZEN_FN,onBlur:b.FROZEN_FN,onChange:b.FROZEN_FN,onSelect:b.FROZEN_FN,onUAChange:b.FROZEN_FN,onLogin:b.FROZEN_FN});t.default=(0,x.ob)(k)},"./src/screens/login/v2/form/styles.ts":(e,t,s)=>{s("./node_modules/core-js/modules/es.object.define-property.js"),s("./node_modules/core-js/modules/es.object.assign.js"),Object.defineProperty(t,"__esModule",{value:!0}),t.memoStyles=void 0;var n=s("./src/stores/index.ts");t.memoStyles=n._.memoStyles((function(){return{form:{width:n._.r(300),paddingBottom:200},input:Object.assign({height:44,paddingVertical:0,paddingHorizontal:14},n._.device(n._.fontSize12,n._.fontSize15),{backgroundColor:n._.colorBg,borderRadius:n._.radiusSm}),touchCaptcha:{height:44,marginLeft:n._.sm,borderRadius:n._.radiusSm,overflow:"hidden"},captchaContainer:{width:118,height:44},captcha:{width:118,height:44},touch:{borderRadius:n._.radiusSm,overflow:"hidden"},content:{paddingVertical:4},touchIcon:{marginLeft:n._.md,borderRadius:20,overflow:"hidden"},icon:{width:36,height:36}}}))},"./src/screens/login/v2/index.tsx":(e,t,s)=>{var n=s("./node_modules/@babel/runtime/regenerator/index.js");s("./node_modules/core-js/modules/es.object.define-property.js"),s("./node_modules/core-js/modules/es.reflect.construct.js"),s("./node_modules/core-js/modules/es.array.concat.js"),s("./node_modules/core-js/modules/es.array.includes.js"),s("./node_modules/core-js/modules/es.string.includes.js"),s("./node_modules/core-js/modules/es.string.match.js"),s("./node_modules/core-js/modules/es.regexp.exec.js"),s("./node_modules/core-js/modules/es.typed-array.uint8-array.js"),s("./node_modules/core-js/modules/es.typed-array.copy-within.js"),s("./node_modules/core-js/modules/es.typed-array.every.js"),s("./node_modules/core-js/modules/es.typed-array.fill.js"),s("./node_modules/core-js/modules/es.typed-array.filter.js"),s("./node_modules/core-js/modules/es.typed-array.find.js"),s("./node_modules/core-js/modules/es.typed-array.find-index.js"),s("./node_modules/core-js/modules/es.typed-array.for-each.js"),s("./node_modules/core-js/modules/es.typed-array.includes.js"),s("./node_modules/core-js/modules/es.typed-array.index-of.js"),s("./node_modules/core-js/modules/es.typed-array.iterator.js"),s("./node_modules/core-js/modules/es.typed-array.join.js"),s("./node_modules/core-js/modules/es.typed-array.last-index-of.js"),s("./node_modules/core-js/modules/es.typed-array.map.js"),s("./node_modules/core-js/modules/es.typed-array.reduce.js"),s("./node_modules/core-js/modules/es.typed-array.reduce-right.js"),s("./node_modules/core-js/modules/es.typed-array.reverse.js"),s("./node_modules/core-js/modules/es.typed-array.set.js"),s("./node_modules/core-js/modules/es.typed-array.slice.js"),s("./node_modules/core-js/modules/es.typed-array.some.js"),s("./node_modules/core-js/modules/es.typed-array.sort.js"),s("./node_modules/core-js/modules/es.typed-array.subarray.js"),s("./node_modules/core-js/modules/es.typed-array.to-locale-string.js"),s("./node_modules/core-js/modules/es.typed-array.to-string.js"),s("./node_modules/core-js/modules/es.object.to-string.js"),s("./node_modules/core-js/modules/es.array.iterator.js"),s("./node_modules/core-js/modules/es.array-buffer.slice.js"),s("./node_modules/core-js/modules/es.array.join.js"),s("./node_modules/core-js/modules/es.array.slice.js"),s("./node_modules/core-js/modules/es.string.split.js"),s("./node_modules/core-js/modules/es.array.for-each.js"),s("./node_modules/core-js/modules/es.regexp.constructor.js"),s("./node_modules/core-js/modules/es.regexp.to-string.js"),s("./node_modules/core-js/modules/es.string.trim.js"),s("./node_modules/core-js/modules/es.array.map.js"),s("./node_modules/core-js/modules/es.object.keys.js");var o=s("./node_modules/@babel/runtime/helpers/interopRequireDefault.js");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=o(s("./node_modules/@babel/runtime/helpers/asyncToGenerator.js")),a=o(s("./node_modules/@babel/runtime/helpers/classCallCheck.js")),i=o(s("./node_modules/@babel/runtime/helpers/createClass.js")),u=o(s("./node_modules/@babel/runtime/helpers/assertThisInitialized.js")),l=o(s("./node_modules/@babel/runtime/helpers/inherits.js")),d=o(s("./node_modules/@babel/runtime/helpers/possibleConstructorReturn.js")),c=o(s("./node_modules/@babel/runtime/helpers/getPrototypeOf.js")),f=o(s("./node_modules/@babel/runtime/helpers/defineProperty.js")),m=o(s("react")),h=o(s("./node_modules/react-native-web/dist/exports/View/index.js")),p=o(s("./node_modules/cheerio-without-node-native/index.js")),y=o(s("./node_modules/expo-constants/build/Constants.js")),j=s("./src/components/index.ts"),g=s("./src/screens/_/index.ts"),x=s("./src/stores/index.ts"),_=s("./src/utils/index.ts"),b=s("./src/utils/decorators/index.ts"),v=s("./src/utils/fetch/index.ts"),C=s("./src/utils/kv/index.ts"),w=o(s("./src/utils/thirdParty/axios.js")),S=s("./src/constants/index.ts"),A=o(s("./src/constants/i18n/index.ts")),k=s("./src/config.ts"),T=o(s("./src/screens/login/v2/form/index.tsx")),R=o(s("./src/screens/login/v2/preview/index.tsx")),E=s("./src/screens/login/v2/ds.ts"),P=s("./src/screens/login/v2/styles.ts"),F=s("./node_modules/react/jsx-runtime.js");function U(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var s,n=(0,c.default)(e);if(t){var o=(0,c.default)(this).constructor;s=Reflect.construct(n,arguments,o)}else s=n.apply(this,arguments);return(0,d.default)(this,s)}}var N=function(e){(0,l.default)(o,e);var t,s=U(o);function o(){var e,t;(0,a.default)(this,o);for(var i=arguments.length,l=new Array(i),d=0;d<i;d++)l[d]=arguments[d];return e=s.call.apply(s,[this].concat(l)),(0,f.default)((0,u.default)(e),"state",{host:S.WEB?k.HOST_PROXY:S.HOST,clicked:!1,email:"",password:"",captcha:"",base64:"",isCommonUA:!1,loading:!1,info:"",focus:!1,failed:!1}),(0,f.default)((0,u.default)(e),"userAgent",""),(0,f.default)((0,u.default)(e),"formhash",""),(0,f.default)((0,u.default)(e),"lastCaptcha",""),(0,f.default)((0,u.default)(e),"cookie",{}),(0,f.default)((0,u.default)(e),"code",""),(0,f.default)((0,u.default)(e),"accessToken",{}),(0,f.default)((0,u.default)(e),"retryCount",0),(0,f.default)((0,u.default)(e),"codeRef",null),(0,f.default)((0,u.default)(e),"onTour",(0,r.default)(n.mark((function t(){var s,o,r,a;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return(0,v.t)("登陆.游客访问"),t.prev=1,(0,_.info)("正在从github获取游客cookie..."),t.next=5,(0,C.get)("tourist");case 5:s=t.sent,o=s.accessToken,r=s.userCookie,x.userStore.updateAccessToken(o),a=e.props.navigation,x.userStore.updateUserCookie({cookie:r.cookie,userAgent:r.userAgent,v:0,tourist:1}),(0,_.info)(A.default.login()+"成功, 正在请求个人信息...",6),x.userStore.fetchUserInfo(),x.userStore.fetchUsersInfo(),(0,_.feedback)(),a.popToTop(),t.next=22;break;case 18:t.prev=18,t.t0=t.catch(1),console.error(E.NAMESPACE,"onTour",t.t0),(0,_.info)(A.default.login()+"状态过期, 请稍后再试");case 22:case"end":return t.stop()}}),t,null,[[1,18]])})))),(0,f.default)((0,u.default)(e),"onPreviewLogin",(function(){e.setState({clicked:!0})})),(0,f.default)((0,u.default)(e),"loginFail",(t=(0,r.default)(n.mark((function t(s){return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:(0,v.t)("登陆.错误"),e.setState({loading:!1,info:s,failed:!0}),e.reset();case 3:case"end":return t.stop()}}),t)}))),function(e){return t.apply(this,arguments)})),(0,f.default)((0,u.default)(e),"onLogin",(0,r.default)(n.mark((function t(){var s,o,r,a,i,l,d;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(s=e.state,o=s.email,r=s.password,a=s.captcha,o&&r&&a){t.next=4;break}return(0,_.info)("请填写以上字段"),t.abrupt("return");case 4:if(t.prev=4,e.lastCaptcha===a){t.next=21;break}return(0,v.t)("登陆.登陆"),"function"==typeof(null==(i=(0,u.default)(e))||null==(l=i.codeRef)||null==(d=l.inputRef)?void 0:d.blur)&&e.codeRef.inputRef.blur(),(0,_.setStorage)(E.NAMESPACE+"|email",o),t.next=11,e.login();case 11:if(e.cookie.chii_auth){t.next=14;break}return e.loginFail("验证码或密码错误，稍会再重试或前往授权"+A.default.login()+" →"),t.abrupt("return");case 14:return e.lastCaptcha=a,t.next=17,e.oauth();case 17:return t.next=19,e.authorize();case 19:t.next=23;break;case 21:e.setState({info:"重试 (4/5)"}),e.retryCount+=1;case 23:return t.next=25,e.getAccessToken();case 25:(0,_.setStorage)(E.NAMESPACE+"|password",r),e.inStore(),t.next=37;break;case 29:if(t.prev=29,t.t0=t.catch(4),e.retryCount+=1,!(e.retryCount>=E.AUTH_RETRY_COUNT)){t.next=35;break}return e.loginFail("["+String(t.t0)+"] "+A.default.login()+"失败，请重试或重启APP，或点击前往旧版授权"+A.default.login()+" →"),t.abrupt("return");case 35:console.error("login/v2/index.js","onLogin",t.t0),e.onLogin();case 37:case"end":return t.stop()}}),t,null,[[4,29]])})))),(0,f.default)((0,u.default)(e),"getUA",(0,r.default)(n.mark((function t(){var s,o;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.state.isCommonUA){t.next=5;break}return s=E.UA_EKIBUN_BANGUMI_APP,e.userAgent=s,t.abrupt("return",s);case 5:return t.next=7,y.default.getWebViewUserAgentAsync();case 7:return o=t.sent,e.userAgent=S.WEB?o:o+" "+(0,_.getTimestamp)(),t.abrupt("return",o);case 10:case"end":return t.stop()}}),t)})))),(0,f.default)((0,u.default)(e),"getHeaders",(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],s={};return t.includes("User-Agent")&&(s[S.WEB?"X-User-Agent":"User-Agent"]=e.userAgent),t.includes("Cookie")&&(s[S.WEB?"X-Cookie":"Cookie"]=e.cookieString),t.includes("Content-Type")&&(s["Content-Type"]="application/x-www-form-urlencoded"),s})),(0,f.default)((0,u.default)(e),"getCookies",(function(){var t,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.updateCookie(S.WEB?null==s?void 0:s["x-set-cookie"]:null==s||null==(t=s["set-cookie"])?void 0:t[0])})),(0,f.default)((0,u.default)(e),"getFormHash",(0,r.default)(n.mark((function t(){var s,o,r,a,i;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return s=e.state.host,w.default.defaults.withCredentials=!1,t.next=4,(0,w.default)({method:"get",url:s+"/login",headers:e.getHeaders(["User-Agent"])});case 4:return o=t.sent,r=o.data,a=o.headers,e.getCookies(a),(i=r.match(/<input type="hidden" name="formhash" value="(.+?)">/))&&(e.formhash=i[1]),t.abrupt("return",!0);case 10:case"end":return t.stop()}}),t)})))),(0,f.default)((0,u.default)(e),"getCaptcha",(0,r.default)(n.mark((function t(){var s,o,r,a;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.setState({base64:""}),s=e.state.host,w.default.defaults.withCredentials=!1,t.next=5,(0,w.default)({method:"get",url:s+"/signup/captcha?"+(0,_.getTimestamp)(),headers:e.getHeaders(["User-Agent","Cookie"]),responseType:"arraybuffer"});case 5:return o=t.sent,r=o.request,a=S.WEB?btoa(String.fromCharCode.apply(null,new Uint8Array(r.response))):r._response,e.setState({base64:"data:image/gif;base64,"+a,captcha:""}),t.abrupt("return",!0);case 10:case"end":return t.stop()}}),t)})))),(0,f.default)((0,u.default)(e),"login",(0,r.default)(n.mark((function t(){var s,o,r,a,i,u,l,d;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.setState({loading:!0,info:A.default.login()+"请求中...(1/5)"}),s=e.state,o=s.host,r=s.email,a=s.password,i=s.captcha,w.default.defaults.withCredentials=!1,t.next=5,(0,w.default)({method:"post",url:o+"/FollowTheRabbit",headers:e.getHeaders(["User-Agent","Cookie","Content-Type"]),data:(0,_.urlStringify)({formhash:e.formhash,referer:"",dreferer:"",email:r,password:a,captcha_challenge_field:i,loginsubmit:"登录"})});case 5:return u=t.sent,l=u.data,d=u.headers,l.includes("分钟内您将不能登录本站")?(0,_.info)("累计 5 次错误尝试，15 分钟内您将不能"+A.default.login()+"本站。"):e.getCookies(d),t.abrupt("return",!0);case 10:case"end":return t.stop()}}),t)})))),(0,f.default)((0,u.default)(e),"oauth",(0,r.default)(n.mark((function t(){var s,o,r;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.setState({info:"获取授权表单码...(2/5)"}),s=e.state.host,w.default.defaults.withCredentials=!1,t.next=5,(0,w.default)({method:"get",url:s+"/oauth/authorize?client_id="+S.APP_ID+"&response_type=code&redirect_uri="+S.URL_OAUTH_REDIRECT,headers:e.getHeaders(["User-Agent","Cookie"])});case 5:return o=t.sent,r=o.data,e.formhash=p.default.load(r)("input[name=formhash]").attr("value"),t.abrupt("return",!0);case 9:case"end":return t.stop()}}),t)})))),(0,f.default)((0,u.default)(e),"authorize",(0,r.default)(n.mark((function t(){var s,o,r,a;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.setState({info:"授权中...(3/5)"}),o=e.state.host,w.default.defaults.withCredentials=!1,t.next=5,(0,w.default)({method:"post",maxRedirects:0,validateStatus:null,url:o+"/oauth/authorize?client_id="+S.APP_ID+"&response_type=code&redirect_uri="+S.URL_OAUTH_REDIRECT,headers:e.getHeaders(["User-Agent","Cookie","Content-Type"]),data:(0,_.urlStringify)({formhash:e.formhash,redirect_uri:"",client_id:S.APP_ID,submit:"授权"})});case 5:return r=t.sent,a=r.request,e.code=null==a||null==(s=a.responseURL)?void 0:s.split("=").slice(1).join("="),t.abrupt("return",!0);case 9:case"end":return t.stop()}}),t)})))),(0,f.default)((0,u.default)(e),"getAccessToken",(0,r.default)(n.mark((function t(){var s,o,r,a;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.setState({info:"授权成功, 获取token中...(4/5)"}),s=e.state.host,w.default.defaults.withCredentials=!1,t.next=5,(0,w.default)({method:"post",maxRedirects:0,validateStatus:null,url:s+"/oauth/access_token",headers:e.getHeaders(["User-Agent","Content-Type"]),data:(0,_.urlStringify)({grant_type:"authorization_code",client_id:S.APP_ID,client_secret:S.APP_SECRET,code:e.code,redirect_uri:S.URL_OAUTH_REDIRECT,state:(0,_.getTimestamp)()})});case 5:if(o=t.sent,r=o.status,a=o.data,200===r){t.next=10;break}throw new TypeError(r);case 10:return e.accessToken=a,t.abrupt("return",!0);case 12:case"end":return t.stop()}}),t)})))),(0,f.default)((0,u.default)(e),"updateCookie",(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";["__cfduid","chii_sid","chii_sec_id","chii_cookietime","chii_auth"].forEach((function(s){var n=new RegExp(s+"=(.+?);"),o=t.match(n);o&&(e.cookie[s]=o[1])}))})),(0,f.default)((0,u.default)(e),"inStore",(0,r.default)(n.mark((function t(){var s;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.setState({info:A.default.login()+"成功, 正在请求个人信息...(5/5)"}),s=e.props.navigation,x.userStore.updateUserCookie({cookie:e.cookieString,userAgent:e.userAgent,v:0}),x.userStore.updateAccessToken(e.accessToken),(0,_.feedback)(),s.popToTop(),(0,v.t)("登陆.成功"),(0,v.queue)([function(){return x.userStore.fetchUserInfo()},function(){return x.userStore.fetchUsersInfo()},function(){return x.usersStore.fetchFriends()},function(){return x.rakuenStore.downloadFavorTopic()}],1);case 8:case"end":return t.stop()}}),t)})))),(0,f.default)((0,u.default)(e),"reset",(0,r.default)(n.mark((function t(){return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.cookie={},e.setState({base64:""}),e.retryCount=0,t.next=5,e.getUA();case 5:return t.next=7,e.getFormHash();case 7:return t.next=9,e.getCaptcha();case 9:case"end":return t.stop()}}),t)})))),(0,f.default)((0,u.default)(e),"onFocus",(function(){e.setState({focus:!0})})),(0,f.default)((0,u.default)(e),"onBlur",(function(){e.setState({focus:!1})})),(0,f.default)((0,u.default)(e),"onChange",(function(t,s){var n,o=t.nativeEvent.text;e.setState((n={},(0,f.default)(n,s,o),(0,f.default)(n,"info",""),n))})),(0,f.default)((0,u.default)(e),"onSelect",(function(t){(0,_.setStorage)(E.NAMESPACE+"|host",t),e.setState({host:t},(function(){(0,v.t)("登陆.切换域名",{host:t}),e.reset()}))})),(0,f.default)((0,u.default)(e),"onUAChange",(function(){var t=!e.state.isCommonUA;(0,_.setStorage)(E.NAMESPACE+"|isCommonUA",t),e.setState({isCommonUA:t}),e.reset()})),e}return(0,i.default)(o,[{key:"componentDidMount",value:(t=(0,r.default)(n.mark((function e(){var t,s,o,r,a,i;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this,s={},e.next=4,(0,_.getStorage)(E.NAMESPACE+"|host");case 4:return(o=e.sent)&&(s.host=o),e.next=8,(0,_.getStorage)(E.NAMESPACE+"|email");case 8:return(r=e.sent)&&(s.email=r),e.next=12,(0,_.getStorage)(E.NAMESPACE+"|password");case 12:return(a=e.sent)&&(s.password=a),e.next=16,(0,_.getStorage)(E.NAMESPACE+"|isCommonUA");case 16:(i=e.sent)&&(s.isCommonUA=i),this.setState(s,(function(){t.reset()})),(0,v.hm)("login/v2","LoginV2");case 20:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"cookieString",get:function(){var e=this;return Object.keys(this.cookie).map((function(t){return t+"="+e.cookie[t]})).join("; ").trim()}},{key:"renderPreview",value:function(){var e=this;return(0,F.jsx)(R.default,{onLogin:this.onPreviewLogin,onTour:function(){return(0,_.confirm)("将使用开发者的测试账号, 提供大部分功能预览, 确定"+A.default.login()+"? (可以在设置里面退出"+A.default.login()+")",e.onTour,"提示")}})}},{key:"renderForm",value:function(){var e=this,t=this.props.navigation,s=this.state,n=s.host,o=s.email,r=s.password,a=s.captcha,i=s.base64,u=s.isCommonUA,l=s.loading,d=s.info,c=s.failed;return(0,F.jsx)(T.default,{forwardRef:function(t){return e.codeRef=t},navigation:t,email:o,password:r,captcha:a,base64:i,isCommonUA:u,loading:l,info:d,host:n,failed:c,onGetCaptcha:this.getCaptcha,onBlur:this.onBlur,onFocus:this.onFocus,onChange:this.onChange,onSelect:this.onSelect,onUAChange:this.onUAChange,onLogin:this.onLogin})}},{key:"renderContent",value:function(){var e=this,t=this.state,s=t.clicked,n=t.focus;return(0,F.jsxs)(F.Fragment,{children:[(0,F.jsx)(h.default,{style:x._.container.flex,children:s?this.renderForm():this.renderPreview()}),s?!n&&(0,F.jsx)(h.default,{style:this.styles.ps,children:(0,F.jsxs)(j.Text,{size:12,lineHeight:14,type:"sub",children:["隐私策略: 我们十分尊重您的隐私, 我们不会收集上述信息. (多次",A.default.login(),"失败后可能一段时间内不能再次",A.default.login(),")"]})}):(0,F.jsxs)(j.Flex,{style:this.styles.old,justify:"around",children:[!S.WEB&&(0,F.jsxs)(j.Touchable,{onPress:function(){(0,v.t)("登陆.跳转",{to:"Signup"}),(0,_.confirm)("声明: 本APP的性质为第三方，只提供显示数据和简单的操作，没有修复和改变源站业务的能力。 \n\n在移动端浏览器注册会经常遇到验证码错误，碰到错误建议在浏览器里使用 [电脑版UA]，再不行推荐使用电脑Chrome注册。 \n\n注册后会有 [激活码] 发到邮箱，测试过只会发送一次，请务必在激活有效时间内激活，否则这个注册账号就废了。输入激活码前，看见下方的文字改变了再填入，提示服务不可用的请务必等到浏览器加载条完成，不然永远都会说激活码错误。\n\n作者只能帮大家到这里了。",(function(){return(0,_.open)(S.HOST+"/signup")}),"提示",S.FROZEN_FN,"前往注册")},children:[(0,F.jsxs)(j.Flex,{justify:"center",children:[(0,F.jsx)(j.Text,{size:11,type:"sub",bold:!0,children:"注册"}),(0,F.jsx)(j.Iconfont,{style:x._.ml.xxs,name:"md-open-in-new",color:x._.colorSub,size:12})]}),(0,F.jsx)(j.Heatmap,{id:"登陆.跳转",to:"Signup",alias:"注册"})]}),(0,F.jsxs)(j.Touchable,{onPress:function(){(0,v.t)("登陆.跳转",{to:"Privacy"}),(0,_.open)(S.URL_PRIVACY)},children:[(0,F.jsxs)(j.Flex,{justify:"center",children:[(0,F.jsx)(j.Text,{size:11,type:"sub",bold:!0,children:"隐私保护政策"}),(0,F.jsx)(j.Iconfont,{style:x._.ml.xxs,name:"md-open-in-new",color:x._.colorSub,size:12})]}),(0,F.jsx)(j.Heatmap,{id:"登陆.跳转",to:"Privacy",alias:"隐私保护政策"})]}),!S.WEB&&(0,F.jsxs)(j.Text,{size:11,bold:!0,type:"sub",onPress:function(){(0,v.t)("登陆.跳转",{to:"LoginAssist"}),e.props.navigation.push("LoginAssist")},children:["辅助",A.default.login(),(0,F.jsx)(j.Heatmap,{id:"登陆.跳转",to:"LoginAssist",alias:"辅助登录"})]})]})]})}},{key:"render",value:function(){return(0,F.jsxs)(j.Component,{id:"screen-login-v2",style:x._.container.plain,children:[(0,F.jsx)(g.StatusBarPlaceholder,{}),S.WEB&&(0,F.jsxs)(g.Notice,{style:x._.mv.lg,children:["当前网页版",A.default.login(),"功能尚未实装，本页面仅供查看使用"]}),this.renderContent(),(0,F.jsx)(j.KeyboardSpacer,{topSpacing:x._.ios(-120,0)}),(0,F.jsx)(j.Heatmap,{id:"登陆.登陆",right:x._.wind,bottom:x._.bottom+120,transparent:!0}),(0,F.jsx)(j.Heatmap,{id:"登陆.成功",right:x._.wind,bottom:x._.bottom+86,transparent:!0}),(0,F.jsx)(j.Heatmap,{id:"登陆.错误",right:x._.wind,bottom:x._.bottom+52,transparent:!0}),(0,F.jsx)(j.Heatmap,{id:"登陆",screen:"Login"})]})}},{key:"styles",get:function(){return(0,P.memoStyles)()}}]),o}(m.default.Component);t.default=(0,b.ob)(N)},"./src/screens/login/v2/preview/index.tsx":(e,t,s)=>{s("./node_modules/core-js/modules/es.object.define-property.js");var n=s("./node_modules/@babel/runtime/helpers/interopRequireDefault.js");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;n(s("react"));var o=n(s("./node_modules/react-native-web/dist/exports/View/index.js")),r=s("./src/components/index.ts"),a=s("./src/stores/index.ts"),i=s("./src/utils/index.ts"),u=s("./src/utils/decorators/index.ts"),l=s("./src/constants/index.ts"),d=n(s("./src/constants/i18n/index.ts")),c=s("./src/screens/login/v2/preview/styles.ts"),f=s("./node_modules/react/jsx-runtime.js");t.default=(0,u.ob)((function(e){var t=e.onLogin,s=void 0===t?l.FROZEN_FN:t,n=e.onTour,u=void 0===n?l.FROZEN_FN:n,m=l.WEB?r.Page:o.default;return(0,f.jsxs)(m,{style:a._.container.column,children:[(0,f.jsx)(r.Mesume,{}),(0,f.jsxs)(o.default,{style:c.styles.bottomContainer,children:[(0,f.jsxs)(r.Button,{type:"main",shadow:!0,onPress:s,children:[l.WEB?"":"账号",d.default.login()]}),(0,f.jsxs)(o.default,{style:a._.mt.md,children:[l.WEB?(0,f.jsx)(r.Button,{type:"plain",shadow:!0,onPress:function(){(0,i.open)(l.HOST+"/signup")},children:"注册"}):(0,f.jsx)(r.Button,{type:"plain",shadow:!0,onPress:u,children:"游客预览"}),(0,f.jsx)(r.Heatmap,{id:"登陆.游客访问"})]})]})]})}))},"./src/screens/login/v2/preview/styles.ts":(e,t,s)=>{s("./node_modules/core-js/modules/es.object.define-property.js"),Object.defineProperty(t,"__esModule",{value:!0}),t.styles=void 0;var n=s("./src/stores/index.ts");t.styles=n._.create({bottomContainer:{width:n._.r(300),height:400,marginTop:n._.lg}})},"./src/screens/login/v2/styles.ts":(e,t,s)=>{s("./node_modules/core-js/modules/es.object.define-property.js"),Object.defineProperty(t,"__esModule",{value:!0}),t.memoStyles=void 0;var n=s("./src/stores/index.ts");t.memoStyles=n._.memoStyles((function(){return{old:{position:"absolute",zIndex:1,bottom:n._.bottom,left:n._.wind,right:n._.wind,padding:n._.sm},ps:{position:"absolute",right:2*n._.wind,bottom:n._.bottom,left:2*n._.wind},border:{borderLeftWidth:1,borderColor:n._.colorBorder}}}))}}]);