(self.webpackChunkbangumi_pro=self.webpackChunkbangumi_pro||[]).push([[667],{"./src/screens/login/v2/index.stories.tsx":(e,t,n)=>{n("./node_modules/core-js/modules/es.object.define-property.js"),n("./node_modules/core-js/modules/es.object.assign.js");function s(){return(0,a.jsx)(r.StorybookSPA,{children:(0,a.jsx)(r.StorybookList,{children:(0,a.jsx)(i.default,Object.assign({},(0,r.getStorybookArgs)("LoginV2")))})})}var o=n("./node_modules/@babel/runtime/helpers/interopRequireDefault.js"),r=(Object.defineProperty(t,"__esModule",{value:!0}),t.default=t.LoginV2=void 0,o(n("./node_modules/react/index.js")),n("./src/components/index.ts")),i=o(n("./src/screens/login/v2/index.tsx")),a=n("./node_modules/react/jsx-runtime.js"),o={title:"screens/LoginV2",component:i.default};t.default=o;(t.LoginV2=s).parameters=Object.assign({storySource:{source:"() => (\n  <StorybookSPA>\n    <StorybookList>\n      <Component {...getStorybookArgs('LoginV2')} />\n    </StorybookList>\n  </StorybookSPA>\n)"}},s.parameters)},"./src/screens/login/v2/form/index.tsx":(e,t,n)=>{n("./node_modules/core-js/modules/es.object.define-property.js"),n("./node_modules/core-js/modules/es.reflect.construct.js"),n("./node_modules/core-js/modules/es.array.concat.js"),n("./node_modules/core-js/modules/es.array.includes.js"),n("./node_modules/core-js/modules/es.string.includes.js");var s=n("./node_modules/@babel/runtime/helpers/interopRequireDefault.js"),o=(Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0,s(n("./node_modules/@babel/runtime/helpers/classCallCheck.js"))),r=s(n("./node_modules/@babel/runtime/helpers/createClass.js")),i=s(n("./node_modules/@babel/runtime/helpers/assertThisInitialized.js")),a=s(n("./node_modules/@babel/runtime/helpers/inherits.js")),u=s(n("./node_modules/@babel/runtime/helpers/possibleConstructorReturn.js")),l=s(n("./node_modules/@babel/runtime/helpers/getPrototypeOf.js")),d=s(n("./node_modules/@babel/runtime/helpers/defineProperty.js")),c=s(n("./node_modules/react/index.js")),f=s(n("./node_modules/react-native-web/dist/exports/View/index.js")),p=s(n("./node_modules/react-native-web/dist/exports/Image/index.js")),m=s(n("./node_modules/@ant-design/react-native/lib/activity-indicator/index.js")),h=n("./src/components/index.ts"),g=n("./src/screens/_/index.ts"),x=n("./src/stores/index.ts"),y=n("./src/utils/index.ts"),j=n("./src/utils/decorators/index.ts"),_=n("./src/utils/fetch/index.ts"),b=n("./src/constants/index.ts"),v=s(n("./src/constants/i18n/index.ts")),S=n("./src/screens/login/v2/form/styles.ts"),w=n("./node_modules/react/jsx-runtime.js");function C(n){var s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=(0,l.default)(n);return e=s?(e=(0,l.default)(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),(0,u.default)(this,e)}}var k,A=[b.HOST,b.HOST_2,b.HOST_3],n=(s=c.default.Component,(0,a.default)(T,s),k=C(T),(0,r.default)(T,[{key:"componentDidMount",value:function(){var e,t,n=this.props,s=n.email,o=n.password,n=n.captcha;if(s&&o&&!n)try{"function"==typeof(null==this||null==(e=this.codeRef)||null==(t=e.inputRef)?void 0:t.focus)&&this.codeRef.inputRef.focus()}catch(e){}}},{key:"renderForm",value:function(){var t=this,e=this.props,n=e.email,s=e.password,o=e.captcha,r=e.base64,i=e.forwardRef,a=e.onGetCaptcha,u=e.onFocus,l=e.onBlur,d=e.onChange,e=e.onLogin;return(0,w.jsxs)(w.Fragment,{children:[(0,w.jsx)(h.Flex,{style:x._.mt.lg,children:(0,w.jsx)(h.Flex.Item,{children:(0,w.jsx)(h.Input,{style:this.styles.input,value:n,placeholder:"Email",returnKeyType:"next",onFocus:u,onBlur:l,onChange:function(e){return d(e,"email")},onSubmitEditing:this.onSubmitEditingEmail})})}),(0,w.jsx)(h.Flex,{style:x._.mt.md,children:(0,w.jsx)(h.Flex.Item,{children:(0,w.jsx)(h.Input,{ref:function(e){return t.passwordRef=e},style:this.styles.input,value:s,placeholder:"密码",secureTextEntry:!0,returnKeyType:"next",onFocus:u,onBlur:l,onChange:function(e){return d(e,"password")},onSubmitEditing:this.onSubmitEditingPassword})})}),(0,w.jsxs)(h.Flex,{style:x._.mt.md,children:[(0,w.jsx)(h.Flex.Item,{children:(0,w.jsx)(h.Input,{ref:function(e){i(e),t.codeRef=e},style:this.styles.input,value:o,placeholder:"验证码",returnKeyType:"done",returnKeyLabel:v.default.login(),onFocus:u,onBlur:l,onChange:function(e){return d(e,"captcha")},onSubmitEditing:e})}),(0,w.jsx)(h.Touchable,{style:this.styles.touchCaptcha,onPress:a,children:(0,w.jsx)(h.Flex,{style:this.styles.captchaContainer,justify:"center",children:r?(0,w.jsx)(p.default,{style:this.styles.captcha,source:{uri:r}}):(0,w.jsx)(m.default,{size:"small"})})})]})]})}},{key:"renderConfig",value:function(){var e=this.props,t=e.isCommonUA,n=e.host,s=e.onSelect,e=e.onUAChange;return this.state.config?(0,w.jsxs)(w.Fragment,{children:[(0,w.jsxs)(h.Flex,{style:[this.styles.touch,x._.mt.sm],children:[(0,w.jsx)(h.Flex.Item,{children:(0,w.jsx)(g.Popover,{style:this.styles.touch,data:A,onSelect:s,children:(0,w.jsxs)(h.Flex,{style:this.styles.content,children:[(0,w.jsxs)(h.Text,{type:"sub",size:12,children:["使用 ",n," 进行",v.default.login()]}),(0,w.jsx)(h.Iconfont,{name:"md-keyboard-arrow-down"})]})})}),(0,w.jsx)(h.Touchable,{style:this.styles.touchIcon,onPress:this.onNoticeHost,children:(0,w.jsx)(h.Flex,{style:this.styles.icon,justify:"center",children:(0,w.jsx)(h.Iconfont,{name:"md-info-outline",size:18})})})]}),(0,w.jsxs)(h.Flex,{style:this.styles.touch,children:[(0,w.jsx)(h.Flex.Item,{children:(0,w.jsx)(h.Touchable,{style:this.styles.touch,onPress:e,children:(0,w.jsxs)(h.Flex,{style:this.styles.content,children:[(0,w.jsx)(h.Iconfont,{name:t?"md-radio-button-on":"md-radio-button-off",color:t?x._.colorMain:x._.colorSub,size:18}),(0,w.jsxs)(h.Text,{style:x._.ml.xs,type:"sub",size:12,children:["使用固定UA",v.default.login()," (频繁掉线请勾选)"]})]})})}),(0,w.jsx)(h.Touchable,{style:this.styles.touchIcon,onPress:this.onNoticeUA,children:(0,w.jsx)(h.Flex,{style:this.styles.icon,justify:"center",children:(0,w.jsx)(h.Iconfont,{name:"md-info-outline",size:18})})})]})]}):(0,w.jsxs)(h.Touchable,{style:[this.styles.touch,x._.mt.sm],onPress:this.showConfig,children:[(0,w.jsxs)(h.Flex,{style:this.styles.content,children:[(0,w.jsxs)(h.Text,{type:"sub",size:12,children:[v.default.login(),"配置"]}),(0,w.jsx)(h.Iconfont,{name:"md-navigate-next"})]}),(0,w.jsx)(h.Heatmap,{id:"登陆.切换域名"}),(0,w.jsx)(h.Heatmap,{bottom:-32,id:"登陆.配置提示",transparent:!0})]})}},{key:"renderError",value:function(){var e=this.props,t=e.navigation,e=e.info,n=e.includes("错误");return(0,w.jsxs)(w.Fragment,{children:[(0,w.jsx)(h.Text,{style:x._.mt.md,size:12,lineHeight:16,type:"sub",onPress:function(){n&&t.push("Login")},children:e}),n&&(0,w.jsxs)(h.Text,{style:x._.mt.md,size:12,lineHeight:16,type:"sub",onPress:function(){return t.push("LoginAssist")},children:["请尝试切换另一域名进行重试，或尝试切换wifi或4g网络，实在没法",v.default.login(),"，可点击这里前往辅助",v.default.login(),"→"]})]})}},{key:"render",value:function(){var e=this.props,t=e.loading,e=e.onLogin;return(0,w.jsx)(f.default,{style:x._.container.column,children:(0,w.jsxs)(f.default,{style:this.styles.form,children:[(0,w.jsx)(h.Flex,{justify:"center",children:(0,w.jsx)(h.Mesume,{})}),this.renderForm(),this.renderConfig(),(0,w.jsx)(h.Button,{style:x._.mt.lg,type:"main",shadow:!0,loading:t,onPress:e,children:v.default.login()}),this.renderError()]})})}},{key:"styles",get:function(){return(0,S.memoStyles)()}}]),T);function T(){var s;(0,o.default)(this,T);for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return s=k.call.apply(k,[this].concat(t)),(0,d.default)((0,i.default)(s),"state",{config:!1}),(0,d.default)((0,i.default)(s),"passwordRef",void 0),(0,d.default)((0,i.default)(s),"codeRef",void 0),(0,d.default)((0,i.default)(s),"showConfig",function(){return s.setState({config:!0})}),(0,d.default)((0,i.default)(s),"onNoticeHost",function(){(0,_.t)("登陆.配置提示",{name:"host"}),(0,y.alert)("三个选项都是同一个站点的不同域名，只是具体服务器位置不同。 \n\n"+v.default.login()+"建议优先使用 bgm.tv，出现问题再尝试 bangumi.tv，最后尝试 chii.in。")}),(0,d.default)((0,i.default)(s),"onNoticeUA",function(){(0,_.t)("登陆.配置提示",{name:"ua"}),(0,y.alert)("假如您频繁掉授权状态，不妨试试把这个选项勾上，通常"+v.default.login()+"状态生存时间为7天。 \n\n这是个不稳定的选项，若"+v.default.login()+"正常不建议勾上，可能会遇到预测不能的状况。")}),(0,d.default)((0,i.default)(s),"onSubmitEditingEmail",function(){try{var e,t,n;"function"==typeof(null==(e=(0,i.default)(s))||null==(t=e.passwordRef)||null==(n=t.inputRef)?void 0:n.focus)&&s.passwordRef.inputRef.focus()}catch(e){}}),(0,d.default)((0,i.default)(s),"onSubmitEditingPassword",function(){try{var e,t,n;"function"==typeof(null==(e=(0,i.default)(s))||null==(t=e.codeRef)||null==(n=t.inputRef)?void 0:n.focus)&&s.codeRef.inputRef.focus()}catch(e){}}),s}(0,d.default)(n,"defaultProps",{host:"",forwardRef:function(){},onGetCaptcha:function(){},onFocus:function(){},onBlur:function(){},onChange:function(){},onSelect:function(){},onUAChange:function(){},onLogin:function(){}});b=(0,j.ob)(n);t.default=b;try{form.displayName="form",form.__docgenInfo={description:"",displayName:"form",props:{navigation:{defaultValue:null,description:"",name:"navigation",required:!0,type:{name:"Navigation"}},info:{defaultValue:null,description:"",name:"info",required:!0,type:{name:"string"}},email:{defaultValue:null,description:"",name:"email",required:!0,type:{name:"string"}},password:{defaultValue:null,description:"",name:"password",required:!0,type:{name:"string"}},captcha:{defaultValue:null,description:"",name:"captcha",required:!0,type:{name:"string"}},base64:{defaultValue:null,description:"",name:"base64",required:!0,type:{name:"string"}},isCommonUA:{defaultValue:null,description:"",name:"isCommonUA",required:!0,type:{name:"boolean"}},host:{defaultValue:null,description:"",name:"host",required:!0,type:{name:"string"}},loading:{defaultValue:null,description:"",name:"loading",required:!0,type:{name:"boolean"}},forwardRef:{defaultValue:null,description:"",name:"forwardRef",required:!0,type:{name:"Fn"}},onGetCaptcha:{defaultValue:null,description:"",name:"onGetCaptcha",required:!0,type:{name:"Fn"}},onFocus:{defaultValue:null,description:"",name:"onFocus",required:!0,type:{name:"Fn"}},onBlur:{defaultValue:null,description:"",name:"onBlur",required:!0,type:{name:"Fn"}},onChange:{defaultValue:null,description:"",name:"onChange",required:!0,type:{name:"Fn"}},onLogin:{defaultValue:null,description:"",name:"onLogin",required:!0,type:{name:"Fn"}},onSelect:{defaultValue:null,description:"",name:"onSelect",required:!0,type:{name:"Fn"}},onUAChange:{defaultValue:null,description:"",name:"onUAChange",required:!0,type:{name:"Fn"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/screens/login/v2/form/index.tsx#form"]={docgenInfo:form.__docgenInfo,name:"form",path:"src/screens/login/v2/form/index.tsx#form"})}catch(e){}},"./src/screens/login/v2/form/styles.ts":(e,t,n)=>{n("./node_modules/core-js/modules/es.object.define-property.js"),n("./node_modules/core-js/modules/es.object.assign.js"),Object.defineProperty(t,"__esModule",{value:!0}),t.memoStyles=void 0;var s=n("./src/stores/index.ts"),n=s._.memoStyles(function(){return{form:{width:s._.r(300),paddingBottom:200},input:Object.assign({height:44,paddingVertical:0,paddingHorizontal:14},s._.device(s._.fontSize12,s._.fontSize15),{backgroundColor:s._.colorBg,borderRadius:s._.radiusSm}),touchCaptcha:{height:44,marginLeft:s._.sm,borderRadius:s._.radiusSm,overflow:"hidden"},captchaContainer:{width:118,height:44},captcha:{width:118,height:44},touch:{borderRadius:s._.radiusSm,overflow:"hidden"},content:{paddingVertical:4},touchIcon:{marginLeft:s._.md,borderRadius:20,overflow:"hidden"},icon:{width:36,height:36}}});t.memoStyles=n},"./src/screens/login/v2/index.tsx":(e,t,n)=>{var a=n("./node_modules/@babel/runtime/regenerator/index.js"),s=(n("./node_modules/core-js/modules/es.object.define-property.js"),n("./node_modules/core-js/modules/es.reflect.construct.js"),n("./node_modules/core-js/modules/es.array.concat.js"),n("./node_modules/core-js/modules/es.string.match.js"),n("./node_modules/core-js/modules/es.regexp.exec.js"),n("./node_modules/core-js/modules/es.array.includes.js"),n("./node_modules/core-js/modules/es.string.includes.js"),n("./node_modules/core-js/modules/es.array.join.js"),n("./node_modules/core-js/modules/es.array.slice.js"),n("./node_modules/core-js/modules/es.string.split.js"),n("./node_modules/core-js/modules/es.array.for-each.js"),n("./node_modules/core-js/modules/es.regexp.constructor.js"),n("./node_modules/core-js/modules/es.regexp.to-string.js"),n("./node_modules/core-js/modules/es.array.map.js"),n("./node_modules/core-js/modules/es.object.keys.js"),n("./node_modules/@babel/runtime/helpers/interopRequireDefault.js")),o=(Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0,s(n("./node_modules/@babel/runtime/helpers/asyncToGenerator.js"))),r=s(n("./node_modules/@babel/runtime/helpers/classCallCheck.js")),i=s(n("./node_modules/@babel/runtime/helpers/createClass.js")),u=s(n("./node_modules/@babel/runtime/helpers/assertThisInitialized.js")),l=s(n("./node_modules/@babel/runtime/helpers/inherits.js")),d=s(n("./node_modules/@babel/runtime/helpers/possibleConstructorReturn.js")),c=s(n("./node_modules/@babel/runtime/helpers/getPrototypeOf.js")),f=s(n("./node_modules/@babel/runtime/helpers/defineProperty.js")),p=s(n("./node_modules/react/index.js")),m=s(n("./node_modules/react-native-web/dist/exports/View/index.js")),h=s(n("./node_modules/expo-constants/build/Constants.js")),g=s(n("./node_modules/cheerio-without-node-native/index.js")),x=n("./src/components/index.ts"),y=n("./src/screens/_/index.ts"),j=n("./src/stores/index.ts"),_=n("./src/utils/index.ts"),b=n("./src/utils/decorators/index.ts"),v=n("./src/utils/fetch/index.ts"),S=s(n("./src/utils/thirdParty/axios.js")),w=n("./src/constants/index.ts"),C=s(n("./src/constants/i18n/index.ts")),k=s(n("./src/screens/login/v2/preview/index.tsx")),A=s(n("./src/screens/login/v2/form/index.tsx")),T=n("./src/screens/login/v2/styles.ts"),R=n("./node_modules/react/jsx-runtime.js");function P(n){var s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=(0,c.default)(n);return e=s?(e=(0,c.default)(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),(0,d.default)(this,e)}}var F,L,U="LoginV2",n=(s=p.default.Component,(0,l.default)(I,s),L=P(I),(0,i.default)(I,[{key:"componentDidMount",value:(F=(0,o.default)(a.mark(function e(){var t,n,s,o;return a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this,n={},e.next=4,(0,_.getStorage)(U+"|host");case 4:return(s=e.sent)&&(n.host=s),e.next=8,(0,_.getStorage)(U+"|email");case 8:return(s=e.sent)&&(n.email=s),e.next=12,(0,_.getStorage)(U+"|password");case 12:return(o=e.sent)&&(n.password=o),e.next=16,(0,_.getStorage)(U+"|isCommonUA");case 16:(o=e.sent)&&(n.isCommonUA=o),this.setState(n,function(){t.reset()}),(0,v.hm)("login/v2","LoginV2");case 20:case"end":return e.stop()}},e,this)})),function(){return F.apply(this,arguments)})},{key:"cookieString",get:function(){var t=this;return Object.keys(this.cookie).map(function(e){return e+"="+t.cookie[e]}).join("; ")}},{key:"renderPreview",value:function(){var e=this;return(0,R.jsx)(k.default,{onLogin:this.onPreviewLogin,onTour:function(){return(0,_.confirm)("将使用开发者的测试账号, 提供大部分功能预览, 确定"+C.default.login()+"? (可以在设置里面退出"+C.default.login()+")",e.onTour,"提示")}})}},{key:"renderForm",value:function(){var t=this,e=this.props.navigation,n=this.state,s=n.host,o=n.email,r=n.password,i=n.captcha,a=n.base64,u=n.isCommonUA,l=n.loading,n=n.info;return(0,R.jsx)(A.default,{forwardRef:function(e){return t.codeRef=e},navigation:e,email:o,password:r,captcha:i,base64:a,isCommonUA:u,loading:l,info:n,host:s,onGetCaptcha:this.getCaptcha,onBlur:this.onBlur,onFocus:this.onFocus,onChange:this.onChange,onSelect:this.onSelect,onUAChange:this.onUAChange,onLogin:this.onLogin})}},{key:"renderContent",value:function(){var e=this,t=this.state,n=t.clicked,t=t.focus;return(0,R.jsxs)(R.Fragment,{children:[(0,R.jsx)(m.default,{style:j._.container.flex,children:n?this.renderForm():this.renderPreview()}),n?!t&&(0,R.jsx)(m.default,{style:this.styles.ps,children:(0,R.jsxs)(x.Text,{size:12,lineHeight:14,type:"sub",children:["隐私策略: 我们十分尊重您的隐私, 我们不会收集上述信息. (多次",C.default.login(),"失败后可能一段时间内不能再次",C.default.login(),")"]})}):(0,R.jsxs)(x.Flex,{style:this.styles.old,justify:"around",children:[(0,R.jsxs)(x.Touchable,{onPress:function(){(0,v.t)("登陆.跳转",{to:"Signup"}),(0,_.confirm)("声明: 本APP的性质为第三方，只提供显示数据和简单的操作，没有修复和改变源站业务的能力。 \n\n在移动端浏览器注册会经常遇到验证码错误，碰到错误建议在浏览器里使用 [电脑版UA]，再不行推荐使用电脑Chrome注册。 \n\n注册后会有 [激活码] 发到邮箱，测试过只会发送一次，请务必在激活有效时间内激活，否则这个注册账号就废了。输入激活码前，看见下方的文字改变了再填入，提示服务不可用的请务必等到浏览器加载条完成，不然永远都会说激活码错误。\n\n作者只能帮大家到这里了。",function(){return(0,_.open)("https://bgm.tv/signup")},"提示",function(){},"前往注册")},children:[(0,R.jsxs)(x.Flex,{justify:"center",children:[(0,R.jsx)(x.Text,{size:11,type:"sub",bold:!0,children:"注册"}),(0,R.jsx)(x.Iconfont,{style:j._.ml.xxs,name:"md-open-in-new",color:j._.colorSub,size:12})]}),(0,R.jsx)(x.Heatmap,{id:"登陆.跳转",to:"Signup",alias:"注册"})]}),(0,R.jsxs)(x.Touchable,{onPress:function(){(0,v.t)("登陆.跳转",{to:"Privacy"}),(0,_.open)(w.URL_PRIVACY)},children:[(0,R.jsxs)(x.Flex,{justify:"center",children:[(0,R.jsx)(x.Text,{size:11,type:"sub",bold:!0,children:"隐私保护政策"}),(0,R.jsx)(x.Iconfont,{style:j._.ml.xxs,name:"md-open-in-new",color:j._.colorSub,size:12})]}),(0,R.jsx)(x.Heatmap,{id:"登陆.跳转",to:"Privacy",alias:"隐私保护政策"})]}),(0,R.jsxs)(x.Text,{size:11,bold:!0,type:"sub",onPress:function(){(0,v.t)("登陆.跳转",{to:"Login"}),e.props.navigation.push("Login")},children:["旧版",C.default.login(),(0,R.jsx)(x.Heatmap,{id:"登陆.跳转",to:"Login",alias:"旧版登录"})]}),(0,R.jsxs)(x.Text,{size:11,bold:!0,type:"sub",onPress:function(){(0,v.t)("登陆.跳转",{to:"LoginAssist"}),e.props.navigation.push("LoginAssist")},children:["辅助",C.default.login(),(0,R.jsx)(x.Heatmap,{id:"登陆.跳转",to:"LoginAssist",alias:"辅助登录"})]})]})]})}},{key:"render",value:function(){return(0,R.jsxs)(m.default,{style:j._.container.plain,children:[(0,R.jsx)(x.UM,{title:"登录"}),(0,R.jsx)(x.StatusBarEvents,{backgroundColor:"transparent"}),(0,R.jsx)(y.StatusBarPlaceholder,{}),this.renderContent(),(0,R.jsx)(x.KeyboardSpacer,{topSpacing:j._.ios(-120,0)}),(0,R.jsx)(x.Heatmap,{id:"登陆.登陆",right:j._.wind,bottom:j._.bottom+120,transparent:!0}),(0,R.jsx)(x.Heatmap,{id:"登陆.成功",right:j._.wind,bottom:j._.bottom+86,transparent:!0}),(0,R.jsx)(x.Heatmap,{id:"登陆.错误",right:j._.wind,bottom:j._.bottom+52,transparent:!0}),(0,R.jsx)(x.Heatmap,{id:"登陆",screen:"Login"})]})}},{key:"styles",get:function(){return(0,T.memoStyles)()}}]),I);function I(){var i;(0,r.default)(this,I);for(var t,e=arguments.length,n=new Array(e),s=0;s<e;s++)n[s]=arguments[s];return i=L.call.apply(L,[this].concat(n)),(0,f.default)((0,u.default)(i),"state",{host:w.HOST,clicked:!1,email:"",password:"",captcha:"",base64:"",isCommonUA:!1,loading:!1,info:"",focus:!1}),(0,f.default)((0,u.default)(i),"userAgent",""),(0,f.default)((0,u.default)(i),"formhash",""),(0,f.default)((0,u.default)(i),"lastCaptcha",""),(0,f.default)((0,u.default)(i),"cookie",{}),(0,f.default)((0,u.default)(i),"code",""),(0,f.default)((0,u.default)(i),"accessToken",{}),(0,f.default)((0,u.default)(i),"retryCount",0),(0,f.default)((0,u.default)(i),"codeRef",void 0),(0,f.default)((0,u.default)(i),"onTour",(0,o.default)(a.mark(function e(){var t,n;return a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return(0,v.t)("登陆.游客访问"),e.prev=1,(0,_.info)("正在从github获取游客cookie..."),e.next=5,(0,v.xhrCustom)({url:"https://gitee.com/a296377710/bangumi/raw/master/tourist.json?t="+(0,_.getTimestamp)()});case 5:t=e.sent,t=t._response,t=JSON.parse(t),n=t.accessToken,t=t.userCookie,j.userStore.updateAccessToken(n),n=i.props.navigation,j.userStore.updateUserCookie({cookie:t.cookie,userAgent:t.userAgent,v:0,tourist:1}),(0,_.info)(C.default.login()+"成功, 正在请求个人信息...",6),j.userStore.fetchUserInfo(),j.userStore.fetchUsersInfo(),(0,_.feedback)(),n.popToTop(),e.next=22;break;case 18:e.prev=18,e.t0=e.catch(1),console.error(U,"onTour",e.t0),(0,_.info)(C.default.login()+"状态过期, 请稍后再试");case 22:case"end":return e.stop()}},e,null,[[1,18]])}))),(0,f.default)((0,u.default)(i),"onPreviewLogin",function(){i.setState({clicked:!0})}),(0,f.default)((0,u.default)(i),"loginFail",(t=(0,o.default)(a.mark(function e(t){return a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:(0,v.t)("登陆.错误"),i.setState({loading:!1,info:t}),i.reset();case 3:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)})),(0,f.default)((0,u.default)(i),"onLogin",(0,o.default)(a.mark(function e(){var t,n,s,o;return a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=i.state,t=s.email,n=s.password,s=s.captcha,t&&n&&s){e.next=4;break}return(0,_.info)("请填写以上字段"),e.abrupt("return");case 4:if(e.prev=4,i.lastCaptcha!==s)return(0,v.t)("登陆.登陆"),"function"==typeof(null==(o=(0,u.default)(i))||null==(o=o.codeRef)||null==(o=o.inputRef)?void 0:o.blur)&&i.codeRef.inputRef.blur(),(0,_.setStorage)(U+"|email",t),e.next=11,i.login();e.next=21;break;case 11:if(i.cookie.chii_auth){e.next=14;break}return i.loginFail("验证码或密码错误，稍会再重试或前往授权"+C.default.login()+" →"),e.abrupt("return");case 14:return i.lastCaptcha=s,e.next=17,i.oauth();case 17:return e.next=19,i.authorize();case 19:e.next=23;break;case 21:i.setState({info:"重试 (4/5)"}),i.retryCount+=1;case 23:return e.next=25,i.getAccessToken();case 25:(0,_.setStorage)(U+"|password",n),i.inStore(),e.next=36;break;case 29:if(e.prev=29,e.t0=e.catch(4),10<=i.retryCount)return i.loginFail("["+String(e.t0)+"] "+C.default.login()+"失败，请重试或重启APP，或点击前往旧版授权"+C.default.login()+" →"),e.abrupt("return");e.next=34;break;case 34:console.error("login/v2/index.js","onLogin",e.t0),i.onLogin();case 36:case"end":return e.stop()}},e,null,[[4,29]])}))),(0,f.default)((0,u.default)(i),"getUA",(0,o.default)(a.mark(function e(){var t,n;return a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i.state.isCommonUA)return n="Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Mobile Safari/537.36",i.userAgent=n,e.abrupt("return",n);e.next=5;break;case 5:return t=h.default.getWebViewUserAgentAsync(),e.next=8,t;case 8:return n=e.sent,i.userAgent=n+" "+(0,_.getTimestamp)(),e.abrupt("return",t);case 11:case"end":return e.stop()}},e)}))),(0,f.default)((0,u.default)(i),"getFormHash",(0,o.default)(a.mark(function e(){var t,n,s;return a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=i.state.host,S.default.defaults.withCredentials=!1,e.next=4,(0,S.default)({method:"get",url:t+"/login",headers:{"User-Agent":i.userAgent}});case 4:return t=e.sent,n=t.data,s=t.headers,i.updateCookie(null==s||null==(s=s["set-cookie"])?void 0:s[0]),(s=n.match(/<input type="hidden" name="formhash" value="(.+?)">/))&&(i.formhash=s[1]),e.abrupt("return",!0);case 11:case"end":return e.stop()}},e)}))),(0,f.default)((0,u.default)(i),"getCaptcha",(0,o.default)(a.mark(function e(){var t,n;return a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i.setState({base64:""}),t=i.state.host,S.default.defaults.withCredentials=!1,e.next=5,(0,S.default)({method:"get",url:t+"/signup/captcha?"+(0,_.getTimestamp)(),headers:{Cookie:i.cookieString,"User-Agent":i.userAgent},responseType:"arraybuffer"});case 5:return t=e.sent,n=t.request,i.setState({base64:"data:image/gif;base64,"+n._response,captcha:""}),e.abrupt("return",!0);case 9:case"end":return e.stop()}},e)}))),(0,f.default)((0,u.default)(i),"login",(0,o.default)(a.mark(function e(){var t,n,s,o,r;return a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i.setState({loading:!0,info:C.default.login()+"请求中...(1/5)"}),t=i.state,n=t.host,s=t.email,o=t.password,t=t.captcha,S.default.defaults.withCredentials=!1,e.next=5,(0,S.default)({method:"post",url:n+"/FollowTheRabbit",headers:{"Content-Type":"application/x-www-form-urlencoded",Cookie:i.cookieString,"User-Agent":i.userAgent},data:(0,_.urlStringify)({formhash:i.formhash,referer:"",dreferer:"",email:s,password:o,captcha_challenge_field:t,loginsubmit:"登录"})});case 5:return n=e.sent,s=n.data,o=n.headers,i.updateCookie(null==o||null==(t=o["set-cookie"])?void 0:t[0]),s.includes("分钟内您将不能登录本站")?(0,_.info)("累计 5 次错误尝试，15 分钟内您将不能"+C.default.login()+"本站。"):i.updateCookie(null==o||null==(r=o["set-cookie"])?void 0:r[0]),e.abrupt("return",!0);case 11:case"end":return e.stop()}},e)}))),(0,f.default)((0,u.default)(i),"oauth",(0,o.default)(a.mark(function e(){var t,n;return a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i.setState({info:"获取授权表单码...(2/5)"}),t=i.state.host,S.default.defaults.withCredentials=!1,e.next=5,(0,S.default)({method:"get",url:t+"/oauth/authorize?client_id="+w.APP_ID+"&response_type=code&redirect_uri="+w.URL_OAUTH_REDIRECT,headers:{"User-Agent":i.userAgent,Cookie:i.cookieString}});case 5:return t=e.sent,n=t.data,i.formhash=g.default.load(n)("input[name=formhash]").attr("value"),e.abrupt("return",!0);case 9:case"end":return e.stop()}},e)}))),(0,f.default)((0,u.default)(i),"authorize",(0,o.default)(a.mark(function e(){var t,n;return a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i.setState({info:"授权中...(3/5)"}),t=i.state.host,S.default.defaults.withCredentials=!1,e.next=5,(0,S.default)({method:"post",maxRedirects:0,validateStatus:null,url:t+"/oauth/authorize?client_id="+w.APP_ID+"&response_type=code&redirect_uri="+w.URL_OAUTH_REDIRECT,headers:{"Content-Type":"application/x-www-form-urlencoded","User-Agent":i.userAgent,Cookie:i.cookieString},data:(0,_.urlStringify)({formhash:i.formhash,redirect_uri:"",client_id:w.APP_ID,submit:"授权"})});case 5:return t=e.sent,n=t.request,i.code=null==n||null==(n=n.responseURL)?void 0:n.split("=").slice(1).join("="),e.abrupt("return",!0);case 9:case"end":return e.stop()}},e)}))),(0,f.default)((0,u.default)(i),"getAccessToken",(0,o.default)(a.mark(function e(){var t,n,s;return a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i.setState({info:"授权成功, 获取token中...(4/5)"}),t=i.state.host,S.default.defaults.withCredentials=!1,e.next=5,(0,S.default)({method:"post",maxRedirects:0,validateStatus:null,url:t+"/oauth/access_token",headers:{"Content-Type":"application/x-www-form-urlencoded","User-Agent":i.userAgent},data:(0,_.urlStringify)({grant_type:"authorization_code",client_id:w.APP_ID,client_secret:w.APP_SECRET,code:i.code,redirect_uri:w.URL_OAUTH_REDIRECT,state:(0,_.getTimestamp)()})});case 5:if(t=e.sent,n=t.status,s=t.data,200!==n)throw new TypeError(n);e.next=10;break;case 10:return i.accessToken=s,e.abrupt("return",!0);case 12:case"end":return e.stop()}},e)}))),(0,f.default)((0,u.default)(i),"updateCookie",function(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";["__cfduid","chii_sid","chii_sec_id","chii_cookietime","chii_auth"].forEach(function(e){var t=new RegExp(e+"=(.+?);"),t=n.match(t);t&&(i.cookie[e]=t[1])})}),(0,f.default)((0,u.default)(i),"inStore",(0,o.default)(a.mark(function e(){var t;return a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i.setState({info:C.default.login()+"成功, 正在请求个人信息...(5/5)"}),t=i.props.navigation,j.userStore.updateUserCookie({cookie:i.cookieString,userAgent:i.userAgent,v:0}),j.userStore.updateAccessToken(i.accessToken),(0,_.feedback)(),t.popToTop(),(0,v.t)("登陆.成功"),(0,v.queue)([function(){return j.userStore.fetchUserInfo()},function(){return j.userStore.fetchUsersInfo()},function(){return j.usersStore.fetchFriends()},function(){return j.rakuenStore.downloadFavorTopic()}],1);case 8:case"end":return e.stop()}},e)}))),(0,f.default)((0,u.default)(i),"reset",(0,o.default)(a.mark(function e(){return a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i.cookie={},i.setState({base64:""}),i.retryCount=0,e.next=5,i.getUA();case 5:return e.next=7,i.getFormHash();case 7:return e.next=9,i.getCaptcha();case 9:case"end":return e.stop()}},e)}))),(0,f.default)((0,u.default)(i),"onFocus",function(){i.setState({focus:!0})}),(0,f.default)((0,u.default)(i),"onBlur",function(){i.setState({focus:!1})}),(0,f.default)((0,u.default)(i),"onChange",function(e,t){var n,e=e.nativeEvent.text;i.setState(((0,f.default)(n={},t,e),(0,f.default)(n,"info",""),n))}),(0,f.default)((0,u.default)(i),"onSelect",function(e){(0,_.setStorage)(U+"|host",e),i.setState({host:e},function(){(0,v.t)("登陆.切换域名",{host:e}),i.reset()})}),(0,f.default)((0,u.default)(i),"onUAChange",function(){var e=!i.state.isCommonUA;(0,_.setStorage)(U+"|isCommonUA",e),i.setState({isCommonUA:e}),i.reset()}),i}p=(0,b.ob)(n);t.default=p;try{v2.displayName="v2",v2.__docgenInfo={description:"",displayName:"v2",props:{navigation:{defaultValue:null,description:"",name:"navigation",required:!0,type:{name:"Navigation"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/screens/login/v2/index.tsx#v2"]={docgenInfo:v2.__docgenInfo,name:"v2",path:"src/screens/login/v2/index.tsx#v2"})}catch(e){}},"./src/screens/login/v2/preview/index.tsx":(e,t,n)=>{n("./node_modules/core-js/modules/es.object.define-property.js");var s=n("./node_modules/@babel/runtime/helpers/interopRequireDefault.js"),o=(Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0,s(n("./node_modules/react/index.js")),s(n("./node_modules/react-native-web/dist/exports/View/index.js"))),r=n("./src/components/index.ts"),i=n("./src/stores/index.ts"),a=n("./src/utils/decorators/index.ts"),u=s(n("./src/constants/i18n/index.ts")),l=n("./src/screens/login/v2/preview/styles.ts"),d=n("./node_modules/react/jsx-runtime.js");s=(0,a.ob)(function(e){var t=void 0===(t=e.onLogin)?function(){}:t,e=void 0===(e=e.onTour)?function(){}:e;return(0,d.jsxs)(o.default,{style:i._.container.column,children:[(0,d.jsx)(r.Mesume,{}),(0,d.jsxs)(o.default,{style:l.styles.bottomContainer,children:[(0,d.jsxs)(r.Button,{type:"main",shadow:!0,onPress:t,children:["账号",u.default.login()]}),(0,d.jsxs)(o.default,{style:i._.mt.md,children:[(0,d.jsx)(r.Button,{type:"plain",shadow:!0,onPress:e,children:"游客预览"}),(0,d.jsx)(r.Heatmap,{id:"登陆.游客访问"})]})]})]})});t.default=s;try{preview.displayName="preview",preview.__docgenInfo={description:"",displayName:"preview",props:{onLogin:{defaultValue:null,description:"",name:"onLogin",required:!1,type:{name:"() => void"}},onTour:{defaultValue:null,description:"",name:"onTour",required:!1,type:{name:"() => void"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/screens/login/v2/preview/index.tsx#preview"]={docgenInfo:preview.__docgenInfo,name:"preview",path:"src/screens/login/v2/preview/index.tsx#preview"})}catch(e){}},"./src/screens/login/v2/preview/styles.ts":(e,t,n)=>{n("./node_modules/core-js/modules/es.object.define-property.js"),Object.defineProperty(t,"__esModule",{value:!0}),t.styles=void 0;n=n("./src/stores/index.ts"),n=n._.create({bottomContainer:{width:n._.r(300),height:400,marginTop:n._.lg}});t.styles=n},"./src/screens/login/v2/styles.ts":(e,t,n)=>{n("./node_modules/core-js/modules/es.object.define-property.js"),Object.defineProperty(t,"__esModule",{value:!0}),t.memoStyles=void 0;var s=n("./src/stores/index.ts"),n=s._.memoStyles(function(){return{old:{position:"absolute",zIndex:1,bottom:s._.bottom,left:s._.wind,right:s._.wind,padding:s._.sm},ps:{position:"absolute",right:2*s._.wind,bottom:s._.bottom,left:2*s._.wind},border:{borderLeftWidth:1,borderColor:s._.colorBorder}}});t.memoStyles=n}}]);